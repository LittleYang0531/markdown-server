# T3 当希望的最后一片积雨云消逝在炽热的晚霞中之时 (cumulonimbus)

## 题目描述

摇曳的篝火前，jzyz 的大家为chunzhen送别。

但chunzhen不希望过于伤感，他望向面前的 $n$ 个火堆。这 $n$ 个火堆拍成一排，第 $i$ 个火堆的火苗亮度为 $a_i$。

每个时刻，会有风从左往右吹，对于每一个 $a_i$，都会变成 $\max(a_{i - 1}, a_i)$（所有的变化同时产生）。

chunzhen很好奇，他会给出 $q$ 次询问，询问你，$t$ 时刻，$[l, r]$ 区间内所有火堆的亮度和，定义初始时为0时刻。

$1\leq n, q\leq 2\times 10^5$

## 题目分析

以时间轴为纵轴，节点编号为横轴，建立一个平面直角坐标系。

起始有 $n$ 个点，分别在 $(1, 0), (2, 0), ..., (n, 0)$，点的值为 $a_1, a_2, ..., a_n$。

每次向上拓展 $1$ 时，位于 $(i, j)(1\leq i, j\leq n)$ 的点的值为 $\max(val(i, j - 1), val(i - 1, j - 1))$

因此就可以得到一个类似于下图的结构:

![](https://raw.githubusercontent.com/LittleYang0531/image/master/blog/1.jpg)

我们发现，一个数字能够占领的地盘为一个三角形或一个平行四边形(eg: 9 & 7)

然而一个平行四边形又可以通过容斥分成四个三角形加加减减，因此就变成了很多个三角形，然后每次求横着的一行的值之和。

因此我们的目的就是求得这些三角形，然后用数据结构维护。

用单调栈求得上一个**大于**它的数和下一个**大于等于**它的数即可。千万别写成两个大于了，会出问题。

考虑将一次询问 $\text{query}(t_2, l, r)$ 拆分为 $\text{query}(t_2, 1, r) - \text{query}(t_2, 1, l - 1)$(为便于区分，在此将输入参数 $t$ 重命名为 $t_2$)

记录一个三角形的关键信息 $(i, t, c)$ 表示三角形最下面的点的坐标为 $(i, t)$，整个三角形的贡献为 $c$

考虑如何计算一个三角形对于一个询问的贡献。



将询问按照 $r$ 排序，将所有三角形按照 $i$ 进行排序。

每次扫到一个询问 $(t_2, r)$ 时，将所有 $i$ 在 $r$ 及 $r$ 之前的三角形加进线段树中。